{% extends 'home/base.html' %}

{% block title %}í™ˆ - ë‚´ê°€ ë§Œë“œëŠ” ë‚˜ë§Œì˜ AI ì—ì´ì „íŠ¸{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- ì™¼ìª½ ì˜ì—­ (1ë²ˆì°½) - ë¬¸ì„œ -->
    <aside class="left-panel" id="leftPanel">
        <div class="panel-header">
            <h3>ğŸ“„ ë¬¸ì„œ</h3>
            <button class="toggle-btn" onclick="togglePanel('left')" id="leftToggleBtn" title="ìˆ¨ê¸°ê¸°">
                <span class="icon">â€¹</span>
            </button>
        </div>
        <div class="panel-content">
            <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
            <div class="file-select-area">
                <div class="file-input-container">
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
                    <label for="fileInput" class="file-input-label">
                        <span class="file-input-text">íŒŒì¼ ì„ íƒ</span>
                    </label>
                    <button class="upload-btn" onclick="uploadFiles()">
                        <span class="upload-icon">â†‘</span>
                    </button>
                    <label class="background-checkbox">
                        <input type="checkbox" id="backgroundUpload">
                        <span class="checkbox-text">ë°±ê·¸ë¼ìš´ë“œ</span>
                    </label>
                </div>
            </div>

            <!-- íŒŒì¼ ëª©ë¡ ì˜ì—­ -->
            <div class="file-list-area">
                <!-- ëª©ë¡ í—¤ë” -->
                <div class="list-header">
                    <div class="list-header-left">
                        <span class="list-title">íŒŒì¼ëª…</span>
                    </div>
                    <div class="list-header-right">
                        <button class="header-btn settings-btn" title="ì„¤ì •">
                            <span class="icon">âš™</span>
                        </button>
                        <button class="header-btn delete-btn" title="ì‚­ì œ">
                            <span class="icon">ğŸ—‘</span>
                        </button>
                        <button class="header-btn reload-btn" title="ìƒˆë¡œê³ ì¹¨" onclick="reloadFileList()">
                            <span class="icon">â†»</span>
                        </button>
                        <input type="checkbox" class="select-all-checkbox" title="ì „ì²´ ì„ íƒ">
                    </div>
                </div>

                <!-- ëª©ë¡ ë³¸ë¬¸ -->
                <div class="list-body" id="fileListBody">
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">docvqa_temp_1.png</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">docvqa_temp_2.png</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">ë””ì§€í„¸ì‹œë¯¼êµìœ¡ë©”íƒ€ë²„ìŠ¤í”Œë«í¼ë°œí‘œìë£Œ(1-4)_85.pdf</div>
                        <input type="checkbox" class="file-checkbox" checked>
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">ë””ì§€í„¸ì‹œë¯¼êµìœ¡ë©”íƒ€ë²„ìŠ¤í”Œë«í¼ë°œí‘œìë£Œ(1-4)_86.pdf</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">docvqa_temp_3.png</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">ë””ì§€í„¸ì‹œë¯¼êµìœ¡ë©”íƒ€ë²„ìŠ¤í”Œë«í¼ë°œí‘œìë£Œ(1-4)_87.pdf</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">docvqa_temp_4.png</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">ë””ì§€í„¸ì‹œë¯¼êµìœ¡ë©”íƒ€ë²„ìŠ¤í”Œë«í¼ë°œí‘œìë£Œ(1-4)_88.pdf</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">docvqa_temp_5.png</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                    <div class="file-item">
                        <div class="status-indicator active"></div>
                        <div class="file-name">ë””ì§€í„¸ì‹œë¯¼êµìœ¡ë©”íƒ€ë²„ìŠ¤í”Œë«í¼ë°œí‘œìë£Œ(1-4)_89.pdf</div>
                        <input type="checkbox" class="file-checkbox">
                    </div>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination-area">
                    <div class="pagination">
                        <button class="page-btn active">1</button>
                        <button class="page-btn">2</button>
                        <button class="page-btn">3</button>
                        <button class="page-btn">4</button>
                        <button class="page-btn">5</button>
                        <button class="page-btn nav-btn">Â»</button>
                        <button class="page-btn nav-btn">Â»Â»</button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ì¤‘ê°„ ì˜ì—­ (2ë²ˆì°½) - ì±„íŒ… -->
    <main class="center-panel" id="centerPanel">
        <div class="panel-header">
            <h3>ğŸ’¬ ì±„íŒ…</h3>
        </div>
        <div class="panel-content">
            <div class="chat-container">
                <div class="chat-messages">
                    <div class="message ai-message">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! AI ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                        </div>
                    </div>
                    <div class="message user-message">
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! ë¬¸ì„œ ë¶„ì„ì„ ë„ì™€ì£¼ì„¸ìš”.
                        </div>
                        <div class="message-avatar">ğŸ‘¤</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ (3ë²ˆì°½) - ê·¼ê±° -->
    <aside class="right-panel" id="rightPanel">
        <div class="panel-header">
            <h3>ğŸ” ê·¼ê±°</h3>
            <button class="toggle-btn" onclick="togglePanel('right')" id="rightToggleBtn" title="ìˆ¨ê¸°ê¸°">
                <span class="icon">â€º</span>
            </button>
        </div>
        <div class="panel-content">
            <div class="evidence-list">
                <h4>ì°¸ì¡° ê·¼ê±°</h4>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 1 - í˜ì´ì§€ 3</div>
                    <div class="evidence-text">ê´€ë ¨ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 2 - í˜ì´ì§€ 1</div>
                    <div class="evidence-text">ì¶”ê°€ ì°¸ì¡° ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 3 - í˜ì´ì§€ 5</div>
                    <div class="evidence-text">ë” ë§ì€ ê·¼ê±° ìë£Œê°€ ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel.classList.contains('panel-hidden')) {
        showPanel(side);
    } else {
        hidePanel(side);
    }
}

function hidePanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel && toggleBtn) {
        // íŒ¨ë„ì„ ìˆ¨ê¹€ ìƒíƒœë¡œ ì„¤ì •
        panel.classList.add('panel-hidden');
        
        // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ê³¼ íˆ´íŒ ë³€ê²½
        const icon = toggleBtn.querySelector('.icon');
        if (side === 'left') {
            icon.textContent = 'â€º';
            toggleBtn.title = 'ë³´ì´ê¸°';
        } else {
            icon.textContent = 'â€¹';
            toggleBtn.title = 'ë³´ì´ê¸°';
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
        localStorage.setItem(side + 'PanelHidden', 'true');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    }
}

function showPanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel && toggleBtn) {
        // íŒ¨ë„ì„ ë³´ì´ê²Œ í•¨
        panel.classList.remove('panel-hidden');
        
        // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ê³¼ íˆ´íŒ ë³€ê²½
        const icon = toggleBtn.querySelector('.icon');
        if (side === 'left') {
            icon.textContent = 'â€¹';
            toggleBtn.title = 'ìˆ¨ê¸°ê¸°';
        } else {
            icon.textContent = 'â€º';
            toggleBtn.title = 'ìˆ¨ê¸°ê¸°';
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœ ì œê±°
        localStorage.removeItem(side + 'PanelHidden');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    }
}

function adjustCenterPanel() {
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const centerPanel = document.getElementById('centerPanel');
    
    if (!leftPanel || !rightPanel || !centerPanel) return;
    
    const leftHidden = leftPanel.classList.contains('panel-hidden');
    const rightHidden = rightPanel.classList.contains('panel-hidden');
    
    if (leftHidden && rightHidden) {
        centerPanel.style.width = '100%';
    } else if (leftHidden || rightHidden) {
        centerPanel.style.width = '75%';
    } else {
        centerPanel.style.width = '50%';
    }
}

// ì±„íŒ… ê´€ë ¨ í•¨ìˆ˜ë“¤
let isLoading = false;

function handleKeyPress(event) {
    if (event.key === 'Enter' && !isLoading) {
        sendMessage();
    }
}

function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message || isLoading) {
        return;
    }
    
    // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
    chatInput.value = '';
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessageToChat(message, 'user');
    
    // ë¡œë”© ìƒíƒœ ì„¤ì •
    isLoading = true;
    updateSendButton(true);
    
    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    addLoadingMessage();
    
    // API í˜¸ì¶œ
    fetch('/api/send-chat-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        
        if (data.success) {
            // AI ì‘ë‹µ ì¶”ê°€
            addMessageToChat(data.message, 'ai');
        } else {
            // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            addMessageToChat('ì˜¤ë¥˜: ' + data.message, 'ai', true);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        addMessageToChat('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai', true);
    })
    .finally(() => {
        isLoading = false;
        updateSendButton(false);
        chatInput.focus();
    });
}

function addMessageToChat(content, sender, isError = false) {
    const chatMessages = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (isError) {
        messageDiv.style.color = '#ff6b6b';
    }
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">${escapeHtml(content)}</div>
            <div class="message-avatar">ğŸ‘¤</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">${escapeHtml(content)}</div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingMessage() {
    const chatMessages = document.querySelector('.chat-messages');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message ai-message';
    loadingDiv.id = 'loading-message';
    
    loadingDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="loading-message">
            <span>AIê°€ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeLoadingMessage() {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
        loadingMessage.remove();
    }
}

function updateSendButton(loading) {
    const sendBtn = document.querySelector('.send-btn');
    if (loading) {
        sendBtn.textContent = 'ì „ì†¡ì¤‘...';
        sendBtn.disabled = true;
    } else {
        sendBtn.textContent = 'ì „ì†¡';
        sendBtn.disabled = false;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ… ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    loadCurrentLLM();
});

function loadChatHistory() {
    fetch('/api/get-chat-history/')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.messages.length > 0) {
            const chatMessages = document.querySelector('.chat-messages');
            chatMessages.innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            
            // ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
            data.messages.reverse().forEach(message => {
                addMessageToChat(message.req_content, 'user');
                addMessageToChat(message.res_content, 'ai');
            });
        }
    })
    .catch(error => {
        console.error('Error loading chat history:', error);
    });
}

function loadCurrentLLM() {
    fetch('/api/get-current-llm/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Current LLM:', data.model.name);
        }
    })
    .catch(error => {
        console.error('Error loading current LLM:', error);
    });
}
</script>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë¬¸ì„œ ì—…ë¡œë“œ ì„¤ì •</h3>
            <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadSettingsForm">
                <!-- LLM ì„ íƒ -->
                <div class="form-group">
                    <label for="llmSelect">LLM ëª¨ë¸ ì„ íƒ</label>
                    <select id="llmSelect" name="selected_llm" required>
                        <option value="">LLM ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for llm in llm_list %}
                        <option value="{{ llm.id }}">{{ llm.name }} ({{ llm.get_model_type_display }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- í…ìŠ¤íŠ¸ ì¶”ì¶œ ê°€ì´ë“œë¼ì¸ í”„ë¡¬í”„íŠ¸ -->
                <div class="form-group">
                    <label for="promptText">í…ìŠ¤íŠ¸ ì¶”ì¶œ ê°€ì´ë“œë¼ì¸ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="promptText" name="prompt_text" rows="4" placeholder="ë¬¸ì„œì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ë•Œ ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <!-- ì²­í‚¹ ì„¤ì • -->
                <div class="form-group">
                    <label for="chunkSize">ì²­í¬ ê¸€ììˆ˜</label>
                    <input type="number" id="chunkSize" name="chunk_size" value="1000" min="100" max="5000" required>
                    <small class="form-help">ë¬¸ì„œë¥¼ ë‚˜ëˆŒ ì²­í¬ì˜ ê¸€ì ìˆ˜ (100-5000)</small>
                </div>

                <div class="form-group">
                    <label for="chunkOverlap">ì²­í¬ ê²¹ì¹¨ ê¸€ììˆ˜</label>
                    <input type="number" id="chunkOverlap" name="chunk_overlap" value="200" min="0" max="1000" required>
                    <small class="form-help">ì²­í¬ ê°„ ê²¹ì¹˜ëŠ” ê¸€ì ìˆ˜ (0-1000)</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveUploadSettings()">ì„¤ì • ì €ì¥</button>
        </div>
    </div>
</div>

{% endblock %}
