{% extends 'home/base.html' %}

{% block title %}í™ˆ - ë‚´ê°€ ë§Œë“œëŠ” ë‚˜ë§Œì˜ AI ì—ì´ì „íŠ¸{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- ì™¼ìª½ ì˜ì—­ (1ë²ˆì°½) - ë¬¸ì„œ -->
    <aside class="left-panel" id="leftPanel">
        <div class="panel-header">
            <h3>ğŸ“„ ë¬¸ì„œ</h3>
            <button class="toggle-btn" onclick="togglePanel('left')" id="leftToggleBtn" title="ìˆ¨ê¸°ê¸°">
                <span class="icon">â€¹</span>
            </button>
        </div>
        <div class="panel-content">
            <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
            <div class="file-select-area">
                <div class="file-input-container">
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
                    <label for="fileInput" class="file-input-label">
                        <span class="file-input-text">íŒŒì¼ ì„ íƒ</span>
                    </label>
                    <button class="upload-btn" onclick="uploadFiles()">
                        <span class="upload-icon">â†‘</span>
                    </button>
                    <label class="background-checkbox">
                        <input type="checkbox" id="backgroundUpload">
                        <span class="checkbox-text">ë°±ê·¸ë¼ìš´ë“œ</span>
                    </label>
                </div>
            </div>

            <!-- íŒŒì¼ ëª©ë¡ ì˜ì—­ -->
            <div class="file-list-area">
                <!-- ëª©ë¡ í—¤ë” -->
                <div class="list-header">
                    <div class="list-header-left">
                        <span class="list-title">íŒŒì¼ëª…</span>
                    </div>
                    <div class="list-header-right">
                        <button class="header-btn settings-btn" title="ì„¤ì •">
                            <span class="icon">âš™</span>
                        </button>
                        <button class="header-btn delete-btn" title="ì‚­ì œ" onclick="deleteSelectedDocuments()">
                            <span class="icon">ğŸ—‘</span>
                        </button>
                        <button class="header-btn reload-btn" title="ìƒˆë¡œê³ ì¹¨" onclick="reloadFileList()">
                            <span class="icon">â†»</span>
                        </button>
                        <input type="checkbox" class="select-all-checkbox" title="ì „ì²´ ì„ íƒ" onchange="toggleSelectAll(this)">
                    </div>
                </div>

                <!-- ëª©ë¡ ë³¸ë¬¸ -->
                <div class="list-body" id="fileListBody">
                    {% for document in user_documents %}
                    <div class="file-item" data-document-id="{{ document.id }}">
                        <div class="status-indicator active"></div>
                        <div class="file-name">{{ document.file.name|slice:"Document/"|slice:":-1"|slice:"/"|last }}</div>
                        <input type="checkbox" class="file-checkbox" onchange="updateSelectAllCheckbox()">
                    </div>
                    {% empty %}
                    <div class="no-files">
                        <p>ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination-area">
                    <div class="pagination">
                        <button class="page-btn active">1</button>
                        <button class="page-btn">2</button>
                        <button class="page-btn">3</button>
                        <button class="page-btn">4</button>
                        <button class="page-btn">5</button>
                        <button class="page-btn nav-btn">Â»</button>
                        <button class="page-btn nav-btn">Â»Â»</button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ì¤‘ê°„ ì˜ì—­ (2ë²ˆì°½) - ì±„íŒ… -->
    <main class="center-panel" id="centerPanel">
        <div class="panel-header">
            <h3>ğŸ’¬ ì±„íŒ…</h3>
        </div>
        <div class="panel-content">
            <div class="chat-container">
                <div class="chat-messages">
                    <div class="message ai-message">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! AI ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                        </div>
                    </div>
                    <div class="message user-message">
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! ë¬¸ì„œ ë¶„ì„ì„ ë„ì™€ì£¼ì„¸ìš”.
                        </div>
                        <div class="message-avatar">ğŸ‘¤</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ (3ë²ˆì°½) - ê·¼ê±° -->
    <aside class="right-panel" id="rightPanel">
        <div class="panel-header">
            <h3>ğŸ” ê·¼ê±°</h3>
            <button class="toggle-btn" onclick="togglePanel('right')" id="rightToggleBtn" title="ìˆ¨ê¸°ê¸°">
                <span class="icon">â€º</span>
            </button>
        </div>
        <div class="panel-content">
            <div class="evidence-list">
                <h4>ì°¸ì¡° ê·¼ê±°</h4>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 1 - í˜ì´ì§€ 3</div>
                    <div class="evidence-text">ê´€ë ¨ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 2 - í˜ì´ì§€ 1</div>
                    <div class="evidence-text">ì¶”ê°€ ì°¸ì¡° ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
                <div class="evidence-item">
                    <div class="evidence-source">ë¬¸ì„œ 3 - í˜ì´ì§€ 5</div>
                    <div class="evidence-text">ë” ë§ì€ ê·¼ê±° ìë£Œê°€ ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}

function hidePanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel && toggleBtn) {
        // íŒ¨ë„ì„ ìˆ¨ê¹€ ìƒíƒœë¡œ ì„¤ì •
        panel.classList.add('panel-hidden');
        
        // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ê³¼ íˆ´íŒ ë³€ê²½
        const icon = toggleBtn.querySelector('.icon');
        if (side === 'left') {
            icon.textContent = 'â€º';
            toggleBtn.title = 'ë³´ì´ê¸°';
        } else {
            icon.textContent = 'â€¹';
            toggleBtn.title = 'ë³´ì´ê¸°';
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
        localStorage.setItem(side + 'PanelHidden', 'true');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    }
}

function showPanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel && toggleBtn) {
        // íŒ¨ë„ì„ ë³´ì´ê²Œ í•¨
        panel.classList.remove('panel-hidden');
        
        // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ê³¼ íˆ´íŒ ë³€ê²½
        const icon = toggleBtn.querySelector('.icon');
        if (side === 'left') {
            icon.textContent = 'â€¹';
            toggleBtn.title = 'ìˆ¨ê¸°ê¸°';
        } else {
            icon.textContent = 'â€º';
            toggleBtn.title = 'ìˆ¨ê¸°ê¸°';
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœ ì œê±°
        localStorage.removeItem(side + 'PanelHidden');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    }
}

function adjustCenterPanel() {
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const centerPanel = document.getElementById('centerPanel');
    
    if (!leftPanel || !rightPanel || !centerPanel) return;
    
    const leftHidden = leftPanel.classList.contains('panel-hidden');
    const rightHidden = rightPanel.classList.contains('panel-hidden');
    
    if (leftHidden && rightHidden) {
        centerPanel.style.width = '100%';
    } else if (leftHidden || rightHidden) {
        centerPanel.style.width = '75%';
    } else {
        centerPanel.style.width = '50%';
    }
}

// ì±„íŒ… ê´€ë ¨ í•¨ìˆ˜ë“¤
let isLoading = false;

function handleKeyPress(event) {
    if (event.key === 'Enter' && !isLoading) {
        sendMessage();
    }
}

function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message || isLoading) {
        return;
    }
    
    // ì„ íƒëœ ë¬¸ì„œë“¤ ê°€ì ¸ì˜¤ê¸°
    const selectedDocuments = getSelectedDocuments();
    
    // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
    chatInput.value = '';
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessageToChat(message, 'user');
    
    // ë¡œë”© ìƒíƒœ ì„¤ì •
    isLoading = true;
    updateSendButton(true);
    
    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    addLoadingMessage();
    
    // API í˜¸ì¶œ (RAG ì§€ì›)
    const requestBody = {
        message: message
    };
    
    // ì„ íƒëœ ë¬¸ì„œê°€ ìˆìœ¼ë©´ RAG ëª¨ë“œë¡œ ì „ì†¡
    if (selectedDocuments.length > 0) {
        requestBody.selected_documents = selectedDocuments;
    }
    
    fetch('/api/send-chat-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        
        if (data.success) {
            // AI ì‘ë‹µ ì¶”ê°€
            addMessageToChat(data.message, 'ai');
            
            // RAG ëª¨ë“œì¸ ê²½ìš° ì°¸ì¡° ì²­í¬ë“¤ í‘œì‹œ
            if (data.referenced_chunks && data.referenced_chunks.length > 0) {
                displayReferencedChunks(data.referenced_chunks);
            }
        } else {
            // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            addMessageToChat('ì˜¤ë¥˜: ' + data.message, 'ai', true);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        addMessageToChat('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai', true);
    })
    .finally(() => {
        isLoading = false;
        updateSendButton(false);
        chatInput.focus();
    });
}

function addMessageToChat(content, sender, isError = false) {
    const chatMessages = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (isError) {
        messageDiv.style.color = '#ff6b6b';
    }
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">${escapeHtml(content)}</div>
            <div class="message-avatar">ğŸ‘¤</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">${escapeHtml(content)}</div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingMessage() {
    const chatMessages = document.querySelector('.chat-messages');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message ai-message';
    loadingDiv.id = 'loading-message';
    
    loadingDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="loading-message">
            <span>AIê°€ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeLoadingMessage() {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
        loadingMessage.remove();
    }
}

function updateSendButton(loading) {
    const sendBtn = document.querySelector('.send-btn');
    if (loading) {
        sendBtn.textContent = 'ì „ì†¡ì¤‘...';
        sendBtn.disabled = true;
    } else {
        sendBtn.textContent = 'ì „ì†¡';
        sendBtn.disabled = false;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ… ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    loadCurrentLLM();
    loadDocumentList();
});

function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB
    for (let file of files) {
        if (file.size > maxSize) {
            alert(`íŒŒì¼ "${file.name}"ì˜ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
            return;
        }
    }
    
    // FormData ìƒì„±
    const formData = new FormData();
    for (let file of files) {
        formData.append('file', file);
    }
    
    // ì—…ë¡œë“œ ì§„í–‰ í‘œì‹œ
    showUploadProgress();
    
    // íŒŒì¼ ì—…ë¡œë“œ
    fetch('/api/upload-document/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideUploadProgress();
        
        if (data.success) {
            alert(data.message);
            // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadDocumentList();
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            fileInput.value = '';
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideUploadProgress();
        alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function showUploadProgress() {
    const uploadBtn = document.querySelector('.upload-btn');
    uploadBtn.innerHTML = '<span class="upload-icon">â³</span>';
    uploadBtn.disabled = true;
}

function hideUploadProgress() {
    const uploadBtn = document.querySelector('.upload-btn');
    uploadBtn.innerHTML = '<span class="upload-icon">â†‘</span>';
    uploadBtn.disabled = false;
}

function loadDocumentList() {
    fetch('/api/get-user-documents/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDocumentList(data.documents);
        }
    })
    .catch(error => {
        console.error('Error loading documents:', error);
    });
}

function updateDocumentList(documents) {
    const fileListBody = document.getElementById('fileListBody');
    
    if (documents.length === 0) {
        fileListBody.innerHTML = '<div class="no-files"><p>ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        const selectAllCheckbox = document.querySelector('.select-all-checkbox');
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
    }
    
    fileListBody.innerHTML = '';
    documents.forEach(doc => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.setAttribute('data-document-id', doc.id);
        
        fileItem.innerHTML = `
            <div class="status-indicator active"></div>
            <div class="file-name">${doc.filename}</div>
            <input type="checkbox" class="file-checkbox" onchange="updateSelectAllCheckbox()">
        `;
        
        fileListBody.appendChild(fileItem);
    });
    
    // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
    const selectAllCheckbox = document.querySelector('.select-all-checkbox');
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
}

function logout() {
    if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = '/logout/';
    }
}

function reloadFileList() {
    loadDocumentList();
}

function toggleSelectAll(selectAllCheckbox) {
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    fileCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function updateSelectAllCheckbox() {
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    const selectAllCheckbox = document.querySelector('.select-all-checkbox');
    
    const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
    const totalCount = fileCheckboxes.length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function deleteSelectedDocuments() {
    const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('ì‚­ì œí•  ë¬¸ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const documentIds = Array.from(selectedCheckboxes).map(checkbox => {
        const fileItem = checkbox.closest('.file-item');
        return fileItem.getAttribute('data-document-id');
    });
    
    if (confirm(`ì„ íƒí•œ ${documentIds.length}ê°œì˜ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        // ì‚­ì œ ì§„í–‰ í‘œì‹œ
        showDeleteProgress();
        
        // ì‚­ì œ API í˜¸ì¶œ
        fetch('/api/delete-documents/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                document_ids: documentIds
            })
        })
        .then(response => response.json())
        .then(data => {
            hideDeleteProgress();
            
            if (data.success) {
                alert(data.message);
                // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadDocumentList();
                // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                const selectAllCheckbox = document.querySelector('.select-all-checkbox');
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else {
                alert('ì˜¤ë¥˜: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideDeleteProgress();
            alert('ë¬¸ì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

function showDeleteProgress() {
    const deleteBtn = document.querySelector('.delete-btn');
    deleteBtn.innerHTML = '<span class="icon">â³</span>';
    deleteBtn.disabled = true;
}

function hideDeleteProgress() {
    const deleteBtn = document.querySelector('.delete-btn');
    deleteBtn.innerHTML = '<span class="icon">ğŸ—‘</span>';
    deleteBtn.disabled = false;
}

function loadChatHistory() {
    fetch('/api/get-chat-history/')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.messages.length > 0) {
            const chatMessages = document.querySelector('.chat-messages');
            chatMessages.innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            
            // ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
            data.messages.reverse().forEach(message => {
                addMessageToChat(message.req_content, 'user');
                addMessageToChat(message.res_content, 'ai');
            });
        }
    })
    .catch(error => {
        console.error('Error loading chat history:', error);
    });
}

function loadCurrentLLM() {
    fetch('/api/get-current-llm/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Current LLM:', data.model.name);
        }
    })
    .catch(error => {
        console.error('Error loading current LLM:', error);
    });
}
</script>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë¬¸ì„œ ì—…ë¡œë“œ ì„¤ì •</h3>
            <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadSettingsForm">
                <!-- LLM ì„ íƒ -->
                <div class="form-group">
                    <label for="llmSelect">LLM ëª¨ë¸ ì„ íƒ</label>
                    <select id="llmSelect" name="selected_llm" required>
                        <option value="">LLM ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for llm in llm_list %}
                        <option value="{{ llm.id }}">{{ llm.name }} ({{ llm.get_model_type_display }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- í…ìŠ¤íŠ¸ ì¶”ì¶œ ê°€ì´ë“œë¼ì¸ í”„ë¡¬í”„íŠ¸ -->
                <div class="form-group">
                    <label for="promptText">í…ìŠ¤íŠ¸ ì¶”ì¶œ ê°€ì´ë“œë¼ì¸ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="promptText" name="prompt_text" rows="4" placeholder="ë¬¸ì„œì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ë•Œ ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <!-- ì²­í‚¹ ì„¤ì • -->
                <div class="form-group">
                    <label for="chunkSize">ì²­í¬ ê¸€ììˆ˜</label>
                    <input type="number" id="chunkSize" name="chunk_size" value="1000" min="100" max="5000" required>
                    <small class="form-help">ë¬¸ì„œë¥¼ ë‚˜ëˆŒ ì²­í¬ì˜ ê¸€ì ìˆ˜ (100-5000)</small>
                </div>

                <div class="form-group">
                    <label for="chunkOverlap">ì²­í¬ ê²¹ì¹¨ ê¸€ììˆ˜</label>
                    <input type="number" id="chunkOverlap" name="chunk_overlap" value="200" min="0" max="1000" required>
                    <small class="form-help">ì²­í¬ ê°„ ê²¹ì¹˜ëŠ” ê¸€ì ìˆ˜ (0-1000)</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveUploadSettings()">ì„¤ì • ì €ì¥</button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// íŒ¨ë„ í† ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤
function togglePanel(side) {
    const panel = document.getElementById(side + 'Panel');
    const toggleBtn = document.getElementById(side + 'ToggleBtn');
    
    if (panel.classList.contains('panel-hidden')) {
        panel.classList.remove('panel-hidden');
        toggleBtn.innerHTML = '<span class="icon">â€¹</span>';
        toggleBtn.title = 'ìˆ¨ê¸°ê¸°';
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœ ì œê±°
        localStorage.removeItem(side + 'PanelHidden');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    } else {
        panel.classList.add('panel-hidden');
        
        if (side === 'left') {
            toggleBtn.innerHTML = '<span class="icon">â€º</span>';
        } else {
            toggleBtn.innerHTML = '<span class="icon">â€¹</span>';
        }
        toggleBtn.title = 'ë³´ì´ê¸°';
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
        localStorage.setItem(side + 'PanelHidden', 'true');
        
        // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
        adjustCenterPanel();
    }
}

function adjustCenterPanel() {
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const centerPanel = document.getElementById('centerPanel');
    
    if (!leftPanel || !rightPanel || !centerPanel) return;
    
    const leftHidden = leftPanel.classList.contains('panel-hidden');
    const rightHidden = rightPanel.classList.contains('panel-hidden');
    
    if (leftHidden && rightHidden) {
        centerPanel.style.width = '100%';
    } else if (leftHidden || rightHidden) {
        centerPanel.style.width = '75%';
    } else {
        centerPanel.style.width = '50%';
    }
}

// ì±„íŒ… ê´€ë ¨ í•¨ìˆ˜ë“¤
let isLoading = false;

function handleKeyPress(event) {
    if (event.key === 'Enter' && !isLoading) {
        sendMessage();
    }
}

function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message || isLoading) {
        return;
    }
    
    // ì„ íƒëœ ë¬¸ì„œë“¤ ê°€ì ¸ì˜¤ê¸°
    const selectedDocuments = getSelectedDocuments();
    
    // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
    chatInput.value = '';
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessageToChat(message, 'user');
    
    // ë¡œë”© ìƒíƒœ ì„¤ì •
    isLoading = true;
    updateSendButton(true);
    
    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    addLoadingMessage();
    
    // API í˜¸ì¶œ (RAG ì§€ì›)
    const requestBody = {
        message: message
    };
    
    // ì„ íƒëœ ë¬¸ì„œê°€ ìˆìœ¼ë©´ RAG ëª¨ë“œë¡œ ì „ì†¡
    if (selectedDocuments.length > 0) {
        requestBody.selected_documents = selectedDocuments;
    }
    
    fetch('/api/send-chat-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        
        if (data.success) {
            // AI ì‘ë‹µ ì¶”ê°€
            addMessageToChat(data.message, 'ai');
            
            // RAG ëª¨ë“œì¸ ê²½ìš° ì°¸ì¡° ì²­í¬ë“¤ í‘œì‹œ
            if (data.referenced_chunks && data.referenced_chunks.length > 0) {
                displayReferencedChunks(data.referenced_chunks);
            }
        } else {
            // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            addMessageToChat('ì˜¤ë¥˜: ' + data.message, 'ai', true);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage();
        addMessageToChat('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai', true);
    })
    .finally(() => {
        isLoading = false;
        updateSendButton(false);
        chatInput.focus();
    });
}

function addMessageToChat(content, sender, isError = false) {
    const chatMessages = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (isError) {
        messageDiv.style.color = '#f44336';
    }
    
    const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-avatar">${avatar}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${content}</div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingMessage() {
    const chatMessages = document.querySelector('.chat-messages');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message ai-message loading';
    loadingDiv.id = 'loadingMessage';
    loadingDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeLoadingMessage() {
    const loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage) {
        loadingMessage.remove();
    }
}

function updateSendButton(isLoading) {
    const sendBtn = document.querySelector('.send-btn');
    if (isLoading) {
        sendBtn.disabled = true;
        sendBtn.textContent = 'ì „ì†¡ ì¤‘...';
    } else {
        sendBtn.disabled = false;
        sendBtn.textContent = 'ì „ì†¡';
    }
}

// íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
let selectedFiles = [];

function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
    const maxSize = 10 * 1024 * 1024;
    for (let file of files) {
        if (file.size > maxSize) {
            alert(`íŒŒì¼ "${file.name}"ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`);
            return;
        }
    }
    
    // íŒŒì¼ ì—…ë¡œë“œ
    const formData = new FormData();
    for (let file of files) {
        formData.append('file', file);
    }
    
    // ì—…ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const uploadBtn = document.querySelector('.upload-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="upload-icon">â³</span>';
    
    fetch('/api/upload-document/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            location.reload();
        } else {
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    })
    .finally(() => {
        // ì—…ë¡œë“œ ë²„íŠ¼ ë³µì›
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<span class="upload-icon">â†‘</span>';
        fileInput.value = '';
    });
}

// íŒŒì¼ ì„ íƒ ì‹œ ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
document.getElementById('fileInput').addEventListener('change', function() {
    const uploadBtn = document.querySelector('.upload-btn');
    if (this.files.length > 0) {
        uploadBtn.style.opacity = '1';
        uploadBtn.style.cursor = 'pointer';
    } else {
        uploadBtn.style.opacity = '0.5';
        uploadBtn.style.cursor = 'not-allowed';
    }
});

// ì²´í¬ë°•ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
function toggleSelectAll(checkbox) {
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    fileCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

function updateSelectAllCheckbox() {
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    const selectAllCheckbox = document.querySelector('.select-all-checkbox');
    const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedCount === fileCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function deleteSelectedDocuments() {
    const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`ì„ íƒí•œ ${selectedCheckboxes.length}ê°œì˜ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    const documentIds = Array.from(selectedCheckboxes).map(cb => {
        const fileItem = cb.closest('.file-item');
        return parseInt(fileItem.dataset.documentId);
    });
    
    fetch('/api/delete-documents/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            document_ids: documentIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function reloadFileList() {
    location.reload();
}

// ì„¤ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
function openSettingsModal() {
    document.getElementById('settingsModal').style.display = 'block';
    loadUploadSettings();
}

function closeSettingsModal() {
    document.getElementById('settingsModal').style.display = 'none';
}

function loadUploadSettings() {
    fetch('/api/get-upload-settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                if (settings.selected_llm) {
                    document.getElementById('llmSelect').value = settings.selected_llm;
                }
                if (settings.prompt_text) {
                    document.getElementById('promptText').value = settings.prompt_text;
                }
                if (settings.chunk_size) {
                    document.getElementById('chunkSize').value = settings.chunk_size;
                }
                if (settings.chunk_overlap) {
                    document.getElementById('chunkOverlap').value = settings.chunk_overlap;
                }
            }
        })
        .catch(error => {
            console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

function saveUploadSettings() {
    const formData = {
        selected_llm: document.getElementById('llmSelect').value,
        prompt_text: document.getElementById('promptText').value,
        chunk_size: parseInt(document.getElementById('chunkSize').value),
        chunk_overlap: parseInt(document.getElementById('chunkOverlap').value)
    };
    
    fetch('/api/save-upload-settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeSettingsModal();
        } else {
            alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ íŒ¨ë„ ìƒíƒœ ë³µì›
document.addEventListener('DOMContentLoaded', function() {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ íŒ¨ë„ ìƒíƒœ ë³µì›
    const leftHidden = localStorage.getItem('leftPanelHidden') === 'true';
    const rightHidden = localStorage.getItem('rightPanelHidden') === 'true';
    
    if (leftHidden) {
        document.getElementById('leftPanel').classList.add('panel-hidden');
        document.getElementById('leftToggleBtn').innerHTML = '<span class="icon">â€º</span>';
        document.getElementById('leftToggleBtn').title = 'ë³´ì´ê¸°';
    }
    
    if (rightHidden) {
        document.getElementById('rightPanel').classList.add('panel-hidden');
        document.getElementById('rightToggleBtn').innerHTML = '<span class="icon">â€¹</span>';
        document.getElementById('rightToggleBtn').title = 'ë³´ì´ê¸°';
    }
    
    // ì¤‘ê°„ íŒ¨ë„ í¬ê¸° ì¡°ì •
    adjustCenterPanel();
    
    // RAG ê´€ë ¨ ì´ˆê¸°í™”
    updateDocumentProcessingStatus();
    
    // 5ì´ˆë§ˆë‹¤ ì²˜ë¦¬ ìƒíƒœ í™•ì¸ (ì²˜ë¦¬ ì¤‘ì¸ ë¬¸ì„œê°€ ìˆëŠ” ê²½ìš°)
    setInterval(() => {
        const processingItems = document.querySelectorAll('.status-indicator.processing');
        if (processingItems.length > 0) {
            updateDocumentProcessingStatus();
        }
    }, 5000);
});

// RAG ê´€ë ¨ í•¨ìˆ˜ë“¤

// ì„ íƒëœ ë¬¸ì„œë“¤ ê°€ì ¸ì˜¤ê¸°
function getSelectedDocuments() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    return Array.from(checkboxes).map(checkbox => {
        const fileItem = checkbox.closest('.file-item');
        return parseInt(fileItem.dataset.documentId);
    });
}

// ì°¸ì¡° ì²­í¬ë“¤ í‘œì‹œ
function displayReferencedChunks(referencedChunks) {
    const evidenceList = document.querySelector('.evidence-list');
    if (!evidenceList) return;
    
    // ê¸°ì¡´ ê·¼ê±° ëª©ë¡ í´ë¦¬ì–´
    evidenceList.innerHTML = '<h4>ì°¸ì¡° ê·¼ê±°</h4>';
    
    if (referencedChunks.length === 0) {
        evidenceList.innerHTML += '<p>ì°¸ì¡°ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    referencedChunks.forEach((chunk, index) => {
        const evidenceItem = document.createElement('div');
        evidenceItem.className = 'evidence-item';
        
        const similarity = (chunk.similarity * 100).toFixed(1);
        
        evidenceItem.innerHTML = `
            <div class="evidence-source">
                ${chunk.document_name} - ì²­í¬ ${chunk.chunk_index} (ìœ ì‚¬ë„: ${similarity}%)
            </div>
            <div class="evidence-text">
                ${chunk.content}
            </div>
        `;
        
        evidenceList.appendChild(evidenceItem);
    });
}

// ë¬¸ì„œ ì²˜ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateDocumentProcessingStatus() {
    const fileItems = document.querySelectorAll('.file-item');
    
    fileItems.forEach(item => {
        const documentId = item.dataset.documentId;
        const statusIndicator = item.querySelector('.status-indicator');
        
        // ì²˜ë¦¬ ìƒíƒœ í™•ì¸
        fetch(`/api/document/${documentId}/processing-status/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatusIndicator(statusIndicator, data.processing_status, data.is_processed);
                }
            })
            .catch(error => {
                console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            });
    });
}

// ìƒíƒœ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
function updateStatusIndicator(indicator, status, isProcessed) {
    // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
    indicator.className = 'status-indicator';
    
    switch (status) {
        case 'completed':
            indicator.classList.add('processed');
            indicator.title = 'ì²˜ë¦¬ ì™„ë£Œ';
            break;
        case 'processing':
            indicator.classList.add('processing');
            indicator.title = 'ì²˜ë¦¬ ì¤‘...';
            break;
        case 'failed':
            indicator.classList.add('failed');
            indicator.title = 'ì²˜ë¦¬ ì‹¤íŒ¨';
            break;
        default:
            indicator.classList.add('pending');
            indicator.title = 'ì²˜ë¦¬ ëŒ€ê¸°';
            break;
    }
}

// ë¬¸ì„œ RAG ì²˜ë¦¬ ì‹œì‘
function processDocumentForRAG(documentId) {
    const statusIndicator = document.querySelector(`[data-document-id="${documentId}"] .status-indicator`);
    if (statusIndicator) {
        updateStatusIndicator(statusIndicator, 'processing', false);
    }
    
    fetch('/api/process-document-for-rag/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            document_id: documentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('ë¬¸ì„œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            updateDocumentProcessingStatus();
        } else {
            showNotification('ë¬¸ì„œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + data.message, 'error');
            const statusIndicator = document.querySelector(`[data-document-id="${documentId}"] .status-indicator`);
            if (statusIndicator) {
                updateStatusIndicator(statusIndicator, 'failed', false);
            }
        }
    })
    .catch(error => {
        console.error('ë¬¸ì„œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showNotification('ë¬¸ì„œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
function showNotification(message, type = 'info') {
    // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // ìƒˆ ì•Œë¦¼ ìƒì„±
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    
    // íƒ€ì…ë³„ ìƒ‰ìƒ
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#4CAF50';
            break;
        case 'error':
            notification.style.backgroundColor = '#f44336';
            break;
        case 'warning':
            notification.style.backgroundColor = '#ff9800';
            break;
        default:
            notification.style.backgroundColor = '#2196F3';
            break;
    }
    
    document.body.appendChild(notification);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²˜ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
    updateDocumentProcessingStatus();
    
    // 5ì´ˆë§ˆë‹¤ ì²˜ë¦¬ ìƒíƒœ í™•ì¸ (ì²˜ë¦¬ ì¤‘ì¸ ë¬¸ì„œê°€ ìˆëŠ” ê²½ìš°)
    setInterval(() => {
        const processingItems = document.querySelectorAll('.status-indicator.processing');
        if (processingItems.length > 0) {
            updateDocumentProcessingStatus();
        }
    }, 5000);
});

// CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .status-indicator.processed {
        background-color: #4CAF50 !important;
    }
    
    .status-indicator.processing {
        background-color: #ff9800 !important;
        animation: pulse 1s infinite;
    }
    
    .status-indicator.failed {
        background-color: #f44336 !important;
    }
    
    .status-indicator.pending {
        background-color: #9E9E9E !important;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .evidence-item {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    .evidence-source {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .evidence-text {
        color: #666;
        font-size: 14px;
        line-height: 1.4;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
